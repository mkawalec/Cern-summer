## -*- sh -*-
## Analysis name completion for professor scripts

(type _filedir &> /dev/null) || \
function _filedir() {
	local cur prev commands options command
    cur="${COMP_WORDS[COMP_CWORD]}"
    COMPREPLY=( $(compgen -W "$(ls ${cur}* 2> /dev/null)" -- ${cur}) )
    return 0
}


## Function for doing all the work, but configured to only handle certain functions via string args
function _prof_complete() {
	local cur prev commands options command
	COMPREPLY=()
    cur="${COMP_WORDS[COMP_CWORD]}"
    prev="${COMP_WORDS[COMP_CWORD-1]}"

    ## Shared options
    opts="--help --verbose --quiet --debug --version --no-logo"
    opts="$opts -h -l -v -q"
    echo "$*" | grep -q dirs && opts="$opts --datadir --mcdir --ipoldir --refdir"
    echo "$*" | grep -q outdir && opts="$opts --outdir -o"
    echo "$*" | grep -q obsweights && opts="$opts --obs --obsfile --weights"
    echo "$*" | grep -q runs && opts="$opts --runs --runsfile --runcombs"
    echo "$*" | grep -q ipol && opts="$opts --ipol"

    ## Script-specific options
    echo "$*" | grep -q pinterpolate && opts="$opts --weave --noweave"
    echo "$*" | grep -q ptune && {
        opts="$opts --no-ipolhistos --ipolhistodir --no-params --paramsdir --offset --runnum-offset"
        opts="$opts --minimizer --minos --print-minuit --limits --spmethods --manual-sp --fixed-parameters --error-tunes"
        opts="$opts --eigentunes --eigentunes-dgof"
    }
    echo "$*" | grep -q penvelopes && opts="$opts --tune --cl --logy"
    echo "$*" | grep -q pI && opts="$opts --paramdescrs --paramsfile"
    echo "$*" | grep -q pipolhistos && opts="$opts --params --paramsfile --paramsdir"

    ## Args requiring an ipol type
    if [[ ${prev} == "--ipol" ]]; then
        COMPREPLY=( $(compgen -W "quadratic cubic" -- ${cur}) )
        return 0
    fi

    ## Args requiring a starting point enum
    if [[ ${prev} == "--spmethods" ]]; then
        COMPREPLY=( $(compgen -W "center random manual" -- ${cur}) )
        return 0
    fi

    ## Args requiring a filename
    if (echo ${prev} | egrep -q -- "--\<runs\>|--\<runsfile\>|--\<runcombs\>|--\<limits\>|--\<obs\>|--\<obsfile\>|--\<weights\>|--\<outfile\>|--\<paramdescrs\>|--\<paramsfile\>"); then
        _filedir
        return 0
    fi

    ## Args requiring a directory
    if (echo ${prev} | egrep -q -- "--\<datadir\>|--\<mcdir\>|--\<ipoldir\>|--\<refdir\>|--\<outdir\>|-\<o\>"); then
        _filedir -d
        return 0
    fi

    ## Args requiring an uncalculable argument
    if (echo ${prev} | egrep -q -- "--\<eigentunes-dgof\>"); then
        COMPREPLY=()
        return 0
    fi

    ## Complete on all switches
    COMPREPLY=( $(compgen -W "${opts}" -- ${cur}) )
    if test -n "$COMPREPLY"; then
        return 0
    fi

    return 0
}



## Dumbly apply this rough completion function to all prof-* scripts!
function _prof_common { _prof_complete dirs; return $?; }
for script in prof-batchtune prof-envelopes prof-ipolhistos prof-plotcorrelations prof-runcombs prof-sensitivities \
    prof-terror prof-checkspace prof-I prof-lsobs prof-plotpulls prof-sampleparams prof-showipol prof-tune \
    prof-compare-tunes prof-interpolate prof-mergeminresults prof-plotresultscatter prof-scanchi2 prof-showminresults; do
    complete -F _prof_common -o default $script
done

## Overload with specific versions
function _prof_interpolate { _prof_complete dirs outdir obsweights runs ipol pinterpolate; return $?; }
complete -F _prof_interpolate prof-interpolate

function _prof_tune { _prof_complete dirs outdir obsweights runs ipol ptune; return $?; }
complete -F _prof_tune prof-tune

function _prof_I { _prof_complete dirs outdir obsweights runs ipol pI; return $?; }
complete -F _prof_I prof-I

function _prof_envelopes { _prof_complete dirs outdir obsweights runs ipol penvelopes; return $?; }
complete -F _prof_envelopes prof-envelopes

function _prof_showminresults { _prof_complete dirs runs ipol; test "$?" = "0" && return 0; _filedir pkl; return 0; }
complete -F _prof_showminresults -o default prof-showminresults

function _prof_ipolhistos { _prof_complete dirs runs ipol outdir obsweights pipolhistos return 0; }
complete -F _prof_ipolhistos prof-ipolhistos
