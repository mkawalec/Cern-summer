#! /usr/bin/env python
usage = """ %prog [options] <resultfile 1> <resultfile 2> [<resultfile 3> ...]\n
           or \n
           %prog [options] --fromdir <directory to crawl> \n
        """

import sys, os
from optparse import OptionParser, OptionGroup
from professor.minimize import result
from professor.tools import messages

parser = OptionParser(usage=usage)
parser.add_option("-o", "--outfile", dest="OUTFILE",
                  default="results_merged.pkl",
                  help="name of the (merged) output results file")
parser.add_option("--fromdir", dest="FROMDIR", action="store_true",
        default=False, help="If given, crawl directory given via " +
        "first arg for .pkl files in subdirectories")
(opts, args) = parser.parse_args()

sys.stdout.write(messages.guideline)
sys.stdout.flush()


def crawlDirForResults(crawldir):
    temp = {}
    rlist = []
    # iterate subdirectories and store .pkl files in a dictionary
    for subdir in os.listdir(crawldir):
        try:
            for rfile in os.listdir(subdir):
                if rfile.endswith(".pkl"):
                    temp[subdir] = rfile
        except OSError:
            continue

    # iterate through identified .pkl - files and try do read in Results
    for subdir, f in temp.iteritems():
        try:
            rlist.append(result.ResultList.fromPickle(os.path.join(subdir, f)))
        except:
            continue

    return rlist



if opts.FROMDIR is False:
    resultlists = [result.ResultList.fromPickle(i) for i in args]
else:
    resultlists = crawlDirForResults(args[0])



### Check if all resultfiles belong to the same set of parameters
if resultlists:
    rtn = result.ResultList()

    ### Check same params and append valid results
    pnames0 = sorted( resultlists[0].getParamNames() )
    for rl in resultlists:
        try:
            pnames = rl.getParamNames()
            if not sorted(pnames) == pnames0:
                print "ERROR: parameter names differ!"
                sys.exit(1)
            for result in rl:
                rtn.append(result)
        except:
            pass

    ### Check for consistency among observables used
    try:
        rtn.isValid()
    except ValueError:
        print "ERROR: You are trying to merge results that were derived from "
        print "minimizations that use different observables/weights!"
        sys.exit(1)


    ### Write merged results file to disk
    rtn.write(opts.OUTFILE)
    print "Done. Written merged ResultFiles to %s" % opts.OUTFILE
